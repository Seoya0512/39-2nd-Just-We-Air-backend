# âœˆï¸ JUSTWEAIR, ë‹¹ì‹ ì˜ ì—¬í–‰ì˜ ì²« ì‹œì‘ì„ ìš°ë¦¬(WE)ì™€ í•¨ê»˜..

1. [í”„ë¡œì íŠ¸ ì†Œê°œ](#about-ğŸ¯)
2. [í”„ë¡œì íŠ¸ íšŒê³ ](#review-ğŸ“š)
3. [ê¸°ì–µí•˜ê³  ì‹¶ì€ CODE](#code-âš’ï¸)

<br>

## ABOUT ğŸ¯

ì œì£¼í•­ê³µ ì›¹ì‚¬ì´íŠ¸ë¥¼ ëª¨í‹°ë¸Œë¡œí•œ í•­ê³µê¶Œ ì˜ˆì•½ ì‚¬ì´íŠ¸ ê°œë°œ

### ë‹´ë‹¹ API

- ì†Œì…œ ë¡œê·¸ì¸ ë° ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
- ì£¼ë¬¸ ë‚´ì—­ ì €ì¥ ë° ì¡°íšŒ
- ê²°ì œ ì •ë³´ ì €ì¥ (í† ìŠ¤ API)
- í‹°ì¼“ ì •ë³´ email ë°œì†¡

<br>

## REVIEW ğŸ“š

í”„ë¡œì íŠ¸ ê°œìš” ë° Sprintë³„ ìƒì„¸ íšŒê³ ëŠ” `Velog`ì— ì‘ì„±í•´ ë’€ìŠµë‹ˆë‹¤. ë˜í•œ, ìµœì¢… í”„ë¡œì íŠ¸ ê²°ê³¼ë¬¼ì€ `í”„ë¡œì íŠ¸ ì‹œì—° ì˜ìƒ`ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. [Sprint1 íšŒê³ ](https://velog.io/@seoya_lee/Project2-JUST-WE-AIR-Sprint-1-%ED%9A%8C%EA%B3%A0)

2. [Sprint 2 íšŒê³ ](https://velog.io/@seoya_lee/Project-02-JUSTWEAIR-Sprint-2-%ED%9A%8C%EA%B3%A0)

3. [íŒ€ ë…¸ì…˜ í˜ì´ì§€](https://www.notion.so/55df994935a747258acdb229ff41b7cd?v=b8afae1ca7a74690a1d053f0753526fe)

4. [í”„ë¡œì íŠ¸ ì‹œì—° ì˜ìƒ](https://youtu.be/s5yfkdGG1gI)

<br>
<br>

## CODE âš’ï¸

ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë‹´ë‹¹í–ˆë˜ APIê°€ ë§ë‹¤. ê·¸ ì¤‘ì—ì„œ 3ê°€ì§€ ê¸°ì–µí•˜ê³  ì‹¶ì€ ë¡œì§, ì½”ë“œ ë“¤ì„ ê¸°ë¡í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤.

<br>

### 1. ë¡œê·¸ì¸ ë° ì‚¬ìš©ì ì—…ë°ì´íŠ¸ API ë¡œì§

ì¹´ì¹´ì˜¤ APIë¥¼ í†µí•´ ë°›ì€ ë°ì´í„°ì™€ DBì— ìˆëŠ” íšŒì›ì„ ë¹„êµí•´ì„œ íšŒì›ì¸ ê²½ìš° ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ê²Œ ë˜ë©°, ì—†ëŠ” ê²½ìš° íšŒì› ì •ë³´ ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰í•˜ê²Œ ëœë‹¤. í”„ë¡ íŠ¸ëŠ” ë°±ì—”ë“œì—ì„œ ë³´ë‚¸ responseì— ë”°ë¼ ëœë”ë§ í˜ì´ì§€ë¥¼ ë‹¬ë¦¬í•˜ê²Œ ëœë‹¤.

ì´ë•Œ ê³ ë¯¼ í–ˆë˜ ë¶€ë¶„ì€ `response ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ì „ë‹¬í•´ì•¼ í”„ë¡ íŠ¸ì—ì„œ ë‘ ê²½ìš°ë¥¼ ì‹ë³„ í•  ìˆ˜ ìˆì„ê¹Œ?` ì˜€ë‹¤.

<br>

#### ì²« ì‹œë„ ğŸ˜

ì²˜ìŒì—ëŠ” ê²½ìš°ì˜ ìˆ˜ì— ë”°ë¼ return ê°’ì„ ë‹¤ë¥´ê²Œ ì¤˜ì•¼í•œë‹¤ê³  ìƒê°í–ˆë‹¤. ë˜í•œ, ë¡œê·¸ì¸ì— ì„±ê³µí–ˆì„ ë•Œë§Œ accessTokenì„ ë°œê¸‰í•˜ëŠ” ë¡œì§ì„ ë§Œë“¤ì—ˆë‹¤. ì´ ê²½ìš°, ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸ í•œ í›„ì— ë‹¤ì‹œ ë¡œê·¸ì¸ì„ í•˜ê³ , accessTokenì„ ë°œê¸‰ ë°›ì•„ì•¼ í•œë‹¤.

ë©˜í† ë‹˜ê»˜ì„œ ì½”ë“œ ë¦¬ë·°ë¥¼ í•˜ì‹œë©° ìœ„ì˜ ë°©ë²•ìœ¼ë¡œëŠ” ì‚¬ìš©ìê°€ ì„œë¹„ìŠ¤ ì´ìš© ì¤‘ê°„ì— íƒˆì£¼í•  ìˆ˜ë„ ìˆë‹¤ê³  ë§ì”€í•˜ì…¨ê³  ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ê³ ë¯¼ì„ í•´ë³´ë¼ê³  í•˜ì…¨ë‹¤.

<br>

#### ìµœì¢… ë¡œì§ ğŸ”¥

ê·¸ ê²°ê³¼, ì•„ë˜ì™€ ê°™ì€ ë¡œì§ì„ êµ¬í˜„í•  ìˆ˜ ìˆì—ˆë‹¤.

```jsx
// services/userService.js

const isUser = await userDao.getUserByKakaoId(kakaoId);
let needUpdateUserProfile = false;

if (!isUser) {
  await userDao.storeKakaoId(kakaoId);
  needUpdateUserProfile = true;
}

const user = await userDao.getUserByKakaoId(kakaoId);

if (!user.email) {
  needUpdateUserProfile = true;
}

const payLoad = {
  userId: user.id,
  expiresIn: process.env.JWT_EXPIRES_IN,
};

const accessToken = jwt.sign(payLoad, secretKey);

return {
  accessToken: accessToken,
  needUpdateUserProfile: needUpdateUserProfile,
};
```

í”„ë¡ íŠ¸ì—ì„œëŠ” `needUpdateUserProfile` ì´ë¼ëŠ” ë³€ìˆ˜ì˜ True/Falseê°’ì„ í†µí•´ ëœë”ë§ í˜ì´ì§€ë¥¼ êµ¬ë³„ í•  ìˆ˜ ìˆê²Œ ëœë‹¤. ë˜í•œ, ëª¨ë“  ì¼€ì´ìŠ¤ì— accessTokenì„ ë¶€ì—¬í•¨ìœ¼ë¡œ íšŒì› ì •ë³´ ì—…ë°ì´íŠ¸ ì´í›„ì— ë°”ë¡œ ì˜ˆì•½í˜ì´ì§€ë¡œ ë„˜ê²¨ì£¼ë©° ì„œë¹„ìŠ¤ì˜ ì—°ë™ì„±ì„ ë†’ì˜€ë‹¤. ì¤‘ê°„ ì´íƒˆìê°€ ìƒê¸°ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•¨!

<br>
<br>

### 2. Transaction : ë°ì´í„° í•œ ë²ˆì— ì €ì¥í•˜ê¸°

FEì—ê²Œ ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë°›ì•„ì˜¤ê³ , ì—¬ëŸ¬ Tableì— ë°ì´í„°ë¥¼ ë™ì‹œì— ì €ì¥ í˜¹ì€ ì—…ë°ì´íŠ¸ë¥¼ í•´ì•¼í•˜ëŠ” APIê°€ í•„ìš”í–ˆë‹¤. ì´ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ `Transaction`ì„ í™œìš©í–ˆë‹¤.

íŠ¸ëœì­ì…˜ì€ ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ ë…¼ë¦¬ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ì‘ì—…ìœ¼ë¡œ ë¬¶ì–´ì£¼ê³ , ë°ì´í„°ë² ì´ìŠ¤ì˜ ìƒíƒœë¥¼ ë³€í™”ì‹œí‚¤ëŠ” ì‘ì—… ë‹¨ìœ„ë¥¼ ëœ»í•œë‹¤.

```jsx
// models/orderDao.js

const orderInfoTransaction = async (
  orderId,
  ticket_option_id,
  first_name,
  last_name,
  birth,
  gender,
  mobile_number,
  email,
  ticketNumber
) => {
  return await appDataSource.transaction(async (transactionalEntityManager) => {
    await transactionalEntityManager.query(
      `INSERT INTO passengers(
        first_name,
        last_name,
        birth,
        gender,
        mobile_number,
        email
      ) VALUES (?, ?, ?, ?, ?, ?);
      `,
      [first_name, last_name, birth, gender, mobile_number, email]
    );

    const [{ passengerId }] = await transactionalEntityManager.query(
      `SELECT LAST_INSERT_ID() as passengerId`
    );

    await transactionalEntityManager.query(
      `INSERT INTO orders_tickets (
          order_id,
          ticket_option_id,
          passenger_id,
          ticket_number
      ) VALUES (?, ? , ? , ?);
      `,
      [orderId, ticket_option_id, passengerId, ticketNumber]
    );
  });
};
```

<br>

### 3. Unit Test : mocking ì´ ë­ê¸¸ë˜

Unit Testì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ì„œ `axios` ì™€ ì™¸ë¶€ ëª¨ë“ˆì— ì˜ì¡´í•˜ëŠ” ë¶€ë¶„ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì–´ë ¤ì› ë‹¤. ì´ë¥¼ í•´ê²°í•˜ëŠ” ê¸°ë²•ì´ `mocking` ì´ë‹¤.

ì¹´ì¹´ì˜¤ APIë¥¼ ì—°ë™í•˜ëŠ” ë¶€ë¶„ì—ì„œ axiosë¥¼ ì‚¬ìš©í–ˆëŠ”ë°, ëª¨ë“ˆ ì „ì²´ë¥¼ mock í•˜ëŠ” `jest.mock()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ axiosì˜ ëª¨ë“  ëª¨ë“ˆì„ mock í–ˆë‹¤.

```jsx
// test/users.test.js

const axios = require("axios");
jest.mock("axios");

// ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸
  test("SUCCESS : kakao sign-in", async () => {
    await appDataSource.query(
      `INSERT INTO users (kakao_id, first_name, last_name, birth, mobile_number,email)
        VALUES (12345, "John", "Doe", 19991231, "01045678932", "john12@gmail.com" )`
    );

    axios.mockReturnValue(
      Promise.resolve({
        data: {
          id: 12345,
          kakao_account: {
            email: "young@gmail.com",
            profile: {
              nickname: "ì˜",
              profile_image_url: "image.jpg",
            },
          },
        },
      })
    );
```

<br>

ë‘ ë²ˆì§¸ë¡œ, `LoginRequired`ë¼ëŠ” ëª¨ë“ˆ ì „ì²´ë¥¼ mockí•´ì„œ ì‚¬ìš© í–ˆë‹¤. ì´í›„ mockImplementation í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ ëª¨ì˜ ê°ì²´ë¥¼ ìƒì„±í•´ì„œ ì‘ì„±í•´ í…ŒìŠ¤íŠ¸ì˜ íš¨ìš©ì„±ì„ ë†’ì˜€ë‹¤.

```jsx
// test/users.test.js

const { loginRequired } = require("../utils/auth");
jest.mock("../utils/auth", () => ({ loginRequired: jest.fn() }));

test("SUCCESS : Updated user info", async () => {
  await appDataSource.query(
    `INSERT INTO users (kakao_id)
      VALUES (12345)`
  );

  loginRequired.mockImplementation((req, res, next) => {
    req.user = 1;
    next();
  });
  ...
)
```
